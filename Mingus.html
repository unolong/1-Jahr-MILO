<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MILO</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
  <style>
    :root{ --beige:#f8ecd9; --ink:#3a2d29; --pixel:#c9b9a6; }
    html,body{height:100%; margin:0}
    body{font-family:"Press Start 2P", monospace; color:var(--ink); background:var(--beige)}

    .topbar{position:sticky; top:0; z-index:70; backdrop-filter:saturate(110%) blur(2px); background:rgba(248,236,217,.9); border-bottom:2px solid var(--pixel)}
    .topbar-inner{max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:12px; padding:6px 12px}
    .top-avatar{width:28px; height:28px; border-radius:50%; object-fit:cover; border:2px solid var(--pixel)}
    .top-count{font-size:10px; letter-spacing:1px; line-height:1.4}

    .audio-controls{margin-left:auto; display:flex; gap:6px; align-items:center}
    .audio-controls input[type="range"]{width:120px}
    .btn{padding:6px 8px; font-size:10px; border:2px solid var(--pixel); background:#fff; color:var(--ink); border-radius:8px; box-shadow:0 3px 0 #e2d5c5; cursor:pointer}
    .btn:active{transform:translateY(1px); box-shadow:0 2px 0 #e2d5c5}
    .nowplaying{font-size:10px; opacity:.8}

    /* HERO */
    .hero{position:relative; height:100svh; overflow:hidden}
    .sky{position:absolute; inset:0; background:linear-gradient(#48a8ff, #2e8df3); image-rendering:pixelated; z-index:0; transition:background 0.8s ease}
    .ground{position:absolute; left:0; right:0; bottom:0; height:120px; transition:height .6s ease;
      background: linear-gradient(#37c84a 0 20px, #319f3f 20px 26px, transparent 26px),
                  repeating-linear-gradient(180deg, #7a4b2b 0 10px, #6b3f24 10px 20px);
      box-shadow: inset 0 6px 0 rgba(0,0,0,.15); z-index:1}
    .hero.play .ground{height:260px}

    .hero-center{position:absolute; inset:0; display:grid; place-items:center; text-align:center; color:#fff; text-shadow:0 3px 0 rgba(0,0,0,.25); transition:opacity .4s; z-index:2}
    .hero.play .hero-center{opacity:.05}

    .big-timer{margin:0 10px}
    .big-timer .line{display:block; font-size:clamp(28px, 8vw, 64px); letter-spacing:2px}
    .fine{font-family:"VT323", monospace; font-size:clamp(18px,3vw,28px)}

    .characters{position:absolute; left:0; right:0; bottom:120px; display:flex; gap:18px; justify-content:center; align-items:flex-end; z-index:4; pointer-events:none}
    .characters img{height:90px; image-rendering:pixelated; animation:bob 2s ease-in-out infinite}
    .characters img.npc{height:82px}
    .characters img.garden{height:270px; position:absolute; left:2vw; bottom:0; animation-duration:4s}
    .characters img.house{height:270px; position:absolute; bottom:0; animation-duration:4s}
    .characters img.right{right:2vw}
    /* v18: Startscreen-Layering – Häuser hinter NPCs/Player */
    .characters img.player,.characters img.npc{position:relative; z-index:5}
    .characters img.garden,.characters img.house{z-index:1}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .hero.play .characters{display:none}

    .start-btn{position:absolute; left:50%; transform:translateX(-50%); bottom:250px; display:inline-flex; align-items:center; gap:10px; padding:12px 14px; background:#fff; border:3px solid var(--pixel); border-radius:12px; box-shadow:0 6px 0 #e2d5c5; text-decoration:none; color:var(--ink); font-size:12px; z-index:5}
    .start-btn:hover{transform:translateX(-50%) translateY(1px)}
    .hero.play .start-btn{display:none}

    #gameCanvas{position:absolute; inset:0; display:none}
    .hero.play #gameCanvas{display:block}

    .content{background:var(--beige); padding:36px 16px 80px}
    .wrap{max-width:1100px; margin:0 auto; text-align:center}

    .menu{display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:16px; justify-items:center; margin-top:18px}
    .card{display:grid; gap:10px; place-items:center; padding:16px; border:3px solid var(--pixel); border-radius:12px; background:#fff; color:var(--ink); width:100%; max-width:220px; box-shadow:0 8px 0 #e2d5c5}
    .label{font-size:12px}

    /* Celebration Text */
    .celebrate{position:absolute; inset:auto 0 55%; text-align:center; color:#fff; font-size:14px; text-shadow:0 3px 0 rgba(0,0,0,.35); z-index:6; display:none}
    .celebrate.show{display:block}
  </style>
</head>
<body>
  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <img src="meinbild.jpeg" alt="Wir" class="top-avatar" />
      <div class="top-count"><span id="topYMD">…</span> · <span id="topHMS">…</span></div>
      <div class="audio-controls">
        <button class="btn" id="btnPlay">▶ Play</button>
        <button class="btn" id="btnStop">■ Stop</button>
        <span class="nowplaying" id="np">—</span>
        <input id="vol" type="range" min="0" max="100" value="70" title="Lautstärke">
      </div>
    </div>
  </div>

  <audio id="bgAudio" src="radio.mp3" preload="auto" loop></audio>
  <audio id="sfxJump" src="sfx_jump.mp3" preload="auto"></audio>
  <audio id="sfxPop"  src="sfx_pop.mp3"  preload="auto"></audio>

  <section class="hero" id="hero">
    <div class="sky" id="sky"></div>
    <div class="ground" id="ground"></div>

    <div class="hero-center" id="heroCenter">
      <p class="big-timer">
        <span class="line" id="heroYMD">…</span>
        <span class="fine">seit 18·08·2024 — <span class="flip" id="heroHMS">…</span></span>
      </p>
    </div>

    <div class="characters" id="characters">
      <img class="garden" src="Garten.png" alt="Garten" />
      <img class="player" src="62139b8e.png" alt="Wir zwei" />
      <img class="npc" src="coco.png" alt="Affe Coco" />
      <img class="npc" src="pengussy.png" alt="Pinguin" />
      <img class="npc" src="capy.png" alt="Capybara" />
      <img class="house right" src="lh.png" alt="Haus rechts" />
    </div>

    <button class="start-btn" id="startBtn">🎮 Spiel starten</button>

    <div id="celebrate" class="celebrate">NEUER HIGHSCORE! 🎆</div>
    <canvas id="gameCanvas"></canvas>
  </section>

  <section class="content">
    <div class="wrap">
      <div class="menu">
        <a class="card" href="Reise.html"><div class="label">Bilder</div></a>
        <a class="card" href="puzzle.html"><div class="label">Puzzle</div></a>
      </div>
    </div>
  </section>

  <script>
    /* ===== TIMER ===== */
    const startDate = new Date("2024-08-18T00:00:00");
    const heroYMD = document.getElementById('heroYMD');
    const heroHMS = document.getElementById('heroHMS');
    const topYMD = document.getElementById('topYMD');
    const topHMS = document.getElementById('topHMS');
    function pad(n){return String(n).padStart(2,'0')}
    function diffYMD(now){ let t = new Date(startDate.getTime()); let y=0,m=0; while(true){const nx=new Date(t.getFullYear()+1,t.getMonth(),t.getDate()); if(nx<=now){t=nx;y++;} else break} while(true){const nx=new Date(t.getFullYear(),t.getMonth()+1,t.getDate()); if(nx<=now){t=nx;m++;} else break} const d=Math.floor((now-t)/86400000); return {y,m,d,rest:t}; }
    function renderTimers(){ const now=new Date(); const {y,m,d,rest}=diffYMD(now); let ms = now-rest - d*86400000; const hh=Math.floor(ms/3600000); ms-=hh*3600000; const mm=Math.floor(ms/60000); ms-=mm*60000; const ss=Math.floor(ms/1000); const ymdStr=`${y} Jahr${y===1?'':'e'} · ${m} Monat${m===1?'':'e'} · ${d} Tag${d===1?'':'e'}`; heroYMD.textContent=ymdStr; topYMD.textContent=ymdStr; const hmsStr=`${pad(hh)}:${pad(mm)}:${pad(ss)}`; heroHMS.textContent=hmsStr; topHMS.textContent=hmsStr; }
    renderTimers(); setInterval(renderTimers,1000);

    /* ===== AUDIO ===== */
    const audio=document.getElementById('bgAudio');
    const sfxJump=document.getElementById('sfxJump');
    const sfxPop=document.getElementById('sfxPop');
    const btnPlay=document.getElementById('btnPlay');
    const btnStop=document.getElementById('btnStop');
    const vol=document.getElementById('vol');
    const np=document.getElementById('np');
    btnPlay.addEventListener('click', async ()=>{ try{ await audio.play(); np.textContent = 'Radio: läuft'; }catch(e){ np.textContent = 'Tippe kurz irgendwo'; }});
    btnStop.addEventListener('click', ()=>{ audio.pause(); audio.currentTime = 0; np.textContent = 'Radio: aus'; });
    function applyVol(){ const v=(vol? vol.value:70)/100; audio.volume=v; if(sfxJump) sfxJump.volume=Math.min(1,v*0.9); if(sfxPop) sfxPop.volume=Math.min(1,v); }
    if(vol){ vol.addEventListener('input', applyVol); applyVol(); }

    /* ===== GAME ===== */
    const hero=document.getElementById('hero');
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d');
    const groundEl=document.getElementById('ground');
    const startBtn=document.getElementById('startBtn');
    const skyEl=document.getElementById('sky');
    const celebrateBanner=document.getElementById('celebrate');

    function resize(){ const r=hero.getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; }
    window.addEventListener('resize', ()=>{ resize(); syncPlayerToGround(); }); resize();
    const groundY=()=> canvas.height - groundEl.offsetHeight;

    // Assets
    const sprites={};
    const LOAD_PATHS={
      hind:['hinderniss.png','media/hinderniss.png'],
      motte:['motte.png','media/motte.png'],
      knobi:['knoblauch.png','media/knoblauch.png'],
      wolken:['wolken.png','Wolken.png','media/wolken.png','media/Wolken.png'],
      berge:['berge.png','Berge.png','cityline.png','Cityline.png','media/berge.png','media/Berge.png','media/cityline.png','media/Cityline.png'],
      stand:['62139b8e.png'], run1:['170ab6d5.png'], run2:['c82a6029.png'], jump:['ffd594fd.png'],
      coco:['coco.png','media/coco.png'], pengussy:['pengussy.png','media/pengussy.png'], capy:['capy.png','media/capy.png'],
      garten:['garten.png','Garten.png','media/garten.png','media/Garten.png'],
      tt:['tt.png','TT.png','media/tt.png','media/TT.png'],
      hm:['hm.png','HM.png','media/hm.png','media/HM.png'],
      vm:['vm.png','VM.png','media/vm.png','media/VM.png'],
      lh:['lh.png','LH.png','media/lh.png','media/LH.png'],
      kien:['Kien.png','kien.png','media/Kien.png','media/kien.png'],
      mingoat:['mingoat.png','Mingoat.png','media/mingoat.png','media/Mingoat.png']
    };
    function loadImageWithFallback(list){ return new Promise(res=>{ if(!list||!list.length) return res(null); let i=0; const img=new Image(); img.onload=()=>res(img); img.onerror=()=>{i++; if(i<list.length) img.src=list[i]; else res(img);} ; img.src=list[0]; }); }
    async function preload(){ const keys=Object.keys(LOAD_PATHS); await Promise.all(keys.map(k=> loadImageWithFallback(LOAD_PATHS[k]).then(img=> sprites[k]=img))); }

    // Speed-abhängige Physik
    const BASE_SPEED=450, MAX_SPEED=920;
    function speedT(speed){ return Math.min(1, Math.max(0, (speed-BASE_SPEED)/(MAX_SPEED-BASE_SPEED))); }
    function currentG(speed){ return 2350 * (1 + 0.18*speedT(speed)); }
    function jumpImpulse(speed){ const BASE_J=-1120, MAX_J=-1450; const t=speedT(speed); return BASE_J + (MAX_J-BASE_J)*t; }

    // State
    let running=false, last=0, score=0, best=Number(localStorage.getItem('bestScore')||0), speed=BASE_SPEED, shakeT=0, flashT=0, dying=false, deathT=0,
        celebrating=false, fireworks=[], fireworksT=0, fireworkSpawnT=0;
    const player={x:110, y:0, w:92, h:112, vy:0, onGround:true, duck:false, runT:0, frame:0, frameTime:0, fastFall:false, usedFastFall:false};
    const obstacles=[]; let spawnT=0; let difficulty=0;
    const knobis=[]; let knobiSpawnT=2; let knobiCount=0;
    const popups=[]; const sparks=[]; let mamaHanh=0; const BONUS=20;

    // Wolken & einzelne Berge
    const clouds=[]; let cloudT=0;
    const mountains=[]; let mountainT=0; const BERGE_SINK_PX=12;

    function spawnCloud(initial=false){
      const img=sprites.wolken; if(!img||!img.naturalWidth) return;
      const scale = 0.8 + Math.random()*1.0; // 0.8x..1.8x
      const h = 70*scale; const w = h * (img.naturalWidth/img.naturalHeight);
      const y = 20 + Math.random()* (canvas.height*0.45);
      const par = 0.10 + Math.random()*0.12;
      const alpha = 0.65 + Math.random()*0.15;
      const x = initial? (Math.random()*canvas.width) : (canvas.width + 60);
      clouds.push({x,y,w,h,img,par,alpha});
    }

    function spawnMountain(initial=false){
      const img=sprites.berge; if(!img||!img.naturalWidth) return;
      const scale = 0.9 + Math.random()*0.45; // 0.9..1.35x
      const h = Math.min(180*scale, canvas.height*0.38*scale);
      const aspect = (img.naturalWidth||1)/(img.naturalHeight||1);
      const w = h*aspect;
      const x = initial ? Math.random()*canvas.width : canvas.width + 80;
      const y = groundY() - h + BERGE_SINK_PX; // am Boden, leicht eingesunken
      const par = 0.18 + Math.random()*0.08; // Parallax-Geschwindigkeit
      const alpha = 0.95;
      mountains.push({x,y,w,h,img,par,alpha});
    }

    // Sky + Sun/Moon + Clouds
    function drawSkyAndClouds(){
      const clamp=(v,min=0,max=1)=> Math.max(min, Math.min(max, v));
      const tSun = clamp(score/5000);            // 0..1 bis 5000 → Sunset
      const tNight = clamp((score-5000)/3000);   // 0..1 ab 5000 → Nacht
      function mix(a,b,f){ const ca=parseInt(a.slice(1),16); const cb=parseInt(b.slice(1),16); const ar=(ca>>16)&255, ag=(ca>>8)&255, ab=ca&255; const br=(cb>>16)&255, bg=(cb>>8)&255, bb=cb&255; const r=Math.round(ar+(br-ar)*f), g=Math.round(ag+(bg-ag)*f), b2=Math.round(ab+(bb-ab)*f); return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b2.toString(16).padStart(2,'0')}`; }
      const dayTop='#48a8ff', dayBot='#2e8df3', sunTop='#ff9a5a', sunBot='#d14d68', nightTop='#0c1440', nightBot='#0a0f2a';
      let topCol=mix(dayTop,sunTop,tSun), botCol=mix(dayBot,sunBot,tSun);
      topCol=mix(topCol,nightTop,tNight); botCol=mix(botCol,nightBot,tNight);
      skyEl.style.background = `linear-gradient(${topCol}, ${botCol})`;

      // Sonne blendet aus
      const sunX = 60 + (canvas.width-120)*tSun; const sunY = Math.max(58, canvas.height*0.18); const rs = 52;
      if(1-tNight > 0){ const gS = ctx.createRadialGradient(sunX, sunY, rs*0.4, sunX, sunY, rs*2.0); gS.addColorStop(0,'rgba(255,230,160,0.95)'); gS.addColorStop(1,'rgba(255,150,90,0)'); ctx.save(); ctx.globalAlpha=1-tNight; ctx.fillStyle=gS; ctx.beginPath(); ctx.arc(sunX, sunY, rs, 0, Math.PI*2); ctx.fill(); ctx.restore(); }

      // Mond blendet ein (kommt von rechts)
      if(tNight > 0){ const moonX = canvas.width - 60 - (canvas.width-120)*Math.min(1,tNight); const moonY = Math.max(70, canvas.height*0.16); const rm = 42; const gM = ctx.createRadialGradient(moonX, moonY, rm*0.3, moonX, moonY, rm*1.6); gM.addColorStop(0,'rgba(255,255,230,0.95)'); gM.addColorStop(1,'rgba(255,255,230,0)'); ctx.fillStyle=gM; ctx.beginPath(); ctx.arc(moonX, moonY, rm, 0, Math.PI*2); ctx.fill(); }

      // Wolken
      ctx.save(); clouds.forEach(c=>{ if(!c.img||!c.img.naturalWidth) return; ctx.globalAlpha=c.alpha*(1-0.2*tNight); ctx.drawImage(c.img, c.x, c.y, c.w, c.h); }); ctx.restore();
    }

    function drawMountains(){ if(!mountains.length) return; ctx.save(); mountains.forEach(m=>{ if(m.img && m.img.naturalWidth>0){ ctx.globalAlpha=m.alpha; ctx.drawImage(m.img, m.x, m.y, m.w, m.h); }}); ctx.restore(); }

    // Cameos (500/1000/5000)
    const cameos=[]; let nextCameoScore=500; let nextKienScore=1000; let nextMingoatScore=5000;
    function spawnCameo(){ const houseImgs = [sprites.garten, sprites.tt, sprites.hm, sprites.vm, sprites.lh].filter(i=>i && i.naturalWidth>0); const animalImgs = [sprites.coco, sprites.pengussy, sprites.capy].filter(i=>i && i.naturalWidth>0); const all = houseImgs.concat(animalImgs); if(!all.length) return; const img = all[Math.floor(Math.random()*all.length)]; const isHouse = houseImgs.includes(img); const baseH = isHouse ? 140 : 90; const aspect=(img.naturalWidth||1)/(img.naturalHeight||1); const h=baseH; const w=h*aspect; const x=canvas.width+40; const gy=groundY(); const y=gy-h; cameos.push({x,y,w,h,img,par: isHouse? 0.55 : 0.6}); }
    function spawnKien(){ const img=sprites.kien; if(!img||!img.naturalWidth) return; const aspect=(img.naturalWidth||1)/(img.naturalHeight||1); const h=player.h*3; const w=h*aspect; const x=canvas.width+60; const y=groundY()-h; cameos.push({x,y,w,h,img,par:0.65}); }
    function spawnMingoat(){ const img=sprites.mingoat; if(!img||!img.naturalWidth) return; const aspect=(img.naturalWidth||1)/(img.naturalHeight||1); const h=player.h*3; const w=h*aspect; const x=canvas.width+80; const y=groundY()-h; cameos.push({x,y,w,h,img,par:0.58}); }

    function toStartScreen(){ running=false; hero.classList.remove('play'); score=0; obstacles.length=0; knobis.length=0; popups.length=0; sparks.length=0; knobiCount=0; mamaHanh=0; cameos.length=0; nextCameoScore=500; nextKienScore=1000; nextMingoatScore=5000; clouds.length=0; mountains.length=0; celebrating=false; fireworks.length=0; fireworksT=0; fireworkSpawnT=0; startBtn.style.display='inline-flex'; startBtn.disabled=false; startBtn.textContent='🎮 Spiel starten'; celebrateBanner.classList.remove('show'); }
    function startGame(){ running=true; hero.classList.add('play'); score=0; speed=BASE_SPEED; obstacles.length=0; knobis.length=0; popups.length=0; sparks.length=0; cameos.length=0; nextCameoScore=500; nextKienScore=1000; nextMingoatScore=5000; spawnT=0; knobiSpawnT=1.8; difficulty=0; knobiCount=0; mamaHanh=0; player.y=groundY()-player.h; player.vy=0; player.onGround=true; player.fastFall=false; player.usedFastFall=false; startBtn.style.display='none'; last=0; for(let i=0;i<4;i++) spawnCloud(true); for(let i=0;i<2;i++) spawnMountain(true); mountainT = 2 + Math.random()*3; requestAnimationFrame(loop); celebrateBanner.classList.remove('show'); }

    function jump(){ if(!running) return; if(player.onGround){ if(sfxJump){ try{ sfxJump.currentTime=0; sfxJump.play(); }catch(e){} } player.vy = jumpImpulse(speed); player.onGround=false; player.fastFall=false; player.usedFastFall=false; } else if(!player.usedFastFall){ player.usedFastFall=true; player.fastFall=true; if(player.vy<900) player.vy=900; } }
    function duck(d){ if(!running) return; player.duck=d; }
    addEventListener('keydown', e=>{ if(e.code==='Space'||e.key==='ArrowUp'){ e.preventDefault(); jump(); } if(e.key==='ArrowDown') duck(true); });
    addEventListener('keyup', e=>{ if(e.key==='ArrowDown') duck(false); });
    hero.addEventListener('pointerdown', ()=> jump());

    // Spawns – obere Hindernisse etwas tiefer
    const MIN_GAP = 250; // fairer
    function spawnObstacle(){ const scale=2.1; const isTop = Math.random() < (0.10 + Math.min(0.26, difficulty*0.22)); if(isTop){ const h=(18+Math.random()*18)*scale; const w=28*scale; const gap=Math.max(MIN_GAP, Math.floor(player.h * 2.3)); const baseY = groundY()-h-gap; obstacles.push({x:canvas.width+20, baseY, y:baseY, w, h, kind:'top', t:0, amp:18+Math.random()*24, freq:1+Math.random()*1.2, jumped:false, counted:false}); } else { const w=(16+Math.random()*20)*scale, h=(22+Math.random()*26)*scale; obstacles.push({x:canvas.width+20, y:groundY()-h, w, h, kind:'ground', jumped:false, counted:false}); } }
    function spawnKnobi(){ const float=Math.random()<0.5; const y=float? groundY()-140-Math.random()*50 : groundY()-60; knobis.push({x:canvas.width+20, y, size:36}); }

    const rects=(a,b)=> a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
    const addPopup=(x,y,text)=> popups.push({x,y,vy:-38,t:0,dur:0.9,text});
    function addSparks(x,y){ for(let i=0;i<12;i++){ sparks.push({x,y,vx:(Math.random()*120-60), vy:(-60-Math.random()*80), g:300, t:0, life:0.6, size:2}); } }

    // Feuerwerk
    function addFirework(x,y){ const n = 36 + Math.floor(Math.random()*24); const hue = Math.floor(Math.random()*360); for(let i=0;i<n;i++){ const a = (i/n)*Math.PI*2; const speed = 120 + Math.random()*160; const vx = Math.cos(a)*speed, vy = Math.sin(a)*speed; fireworks.push({x,y,vx,vy,t:0,life:1.2+Math.random()*0.5,size:2+Math.random()*2,color:`hsl(${(hue+Math.random()*40)|0},80%,60%)`}); } }

    function draw(){
      drawSkyAndClouds();
      drawMountains();

      // HUD
      ctx.fillStyle='rgba(0,0,0,.64)'; ctx.fillRect(canvas.width-280,16,260,128);
      ctx.fillStyle='#fff'; ctx.font='12px "Press Start 2P"';
      ctx.fillText('SCORE '+Math.floor(score), canvas.width-270,36);
      ctx.fillText('BEST  '+best, canvas.width-270,54);
      ctx.fillText('KNOBI '+knobiCount, canvas.width-270,72);
      ctx.fillText('MAMA HANH MOMENT '+mamaHanh, canvas.width-270,90);
      ctx.fillText('+'+BONUS+' bei Sprung', canvas.width-270,108);

      // Cameos hinter Player
      ctx.imageSmoothingEnabled=false;
      cameos.forEach(c=>{ if(c.img && c.img.naturalWidth>0) ctx.drawImage(c.img, c.x, c.y, c.w, c.h); });

      // Player
      const bob=player.onGround? Math.sin(player.runT*10)*2 : 0;
      ctx.save(); ctx.translate(player.x+player.w/2, player.y+player.h/2 + bob);
      let img=sprites.stand; if(!player.onGround) img=sprites.jump; else img=(player.frame===0? sprites.run1 : sprites.run2);
      if(img && img.naturalWidth>0) ctx.drawImage(img, -player.w/2, -player.h/2, player.w, player.h);
      ctx.restore();

      // Hindernisse
      obstacles.forEach(o=>{ const tex = o.kind==='top'? sprites.motte : sprites.hind; if(tex && tex.naturalWidth>0){ ctx.drawImage(tex, o.x,o.y,o.w,o.h);} else { ctx.fillStyle='#3a2d29'; ctx.fillRect(o.x,o.y,o.w,o.h);} });

      // Knobi
      knobis.forEach(k=>{ const i=sprites.knobi; if(i&&i.naturalWidth>0) ctx.drawImage(i, k.x-k.size/2, k.y-k.size/2, k.size, k.size); });

      // Popups & Sparks (zeichnen)
      popups.forEach(p=>{ const a=1-p.t/p.dur; if(a<=0) return; ctx.globalAlpha=Math.max(0,a); ctx.font='12px "Press Start 2P"'; ctx.fillStyle='#fff'; ctx.fillText(p.text, p.x, p.y); ctx.globalAlpha=1; });
      ctx.fillStyle='#fff'; sparks.forEach(s=> ctx.fillRect(s.x, s.y, s.size, s.size));

      // Feuerwerk zeichnen (falls aktiv)
      fireworks.forEach(f=>{ const a = 1 - f.t/f.life; if(a<=0) return; ctx.globalAlpha = Math.max(0, a); ctx.fillStyle = f.color; ctx.fillRect(f.x, f.y, f.size, f.size); ctx.globalAlpha = 1; });
    }

    function loop(ts){
      const dt=Math.min(0.02,(ts-last)/1000||0.016); last=ts;

      if(!running && !celebrating) return; // nichts tun

      // Tod-Animation
      if(dying){
        shakeT = Math.max(0, shakeT - dt);
        flashT = Math.max(0, flashT - dt);
        deathT -= dt;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.save(); if(shakeT>0){ const amt = 6*(shakeT/0.22); ctx.translate((Math.random()*2-1)*amt, (Math.random()*2-1)*amt); } draw(); ctx.restore();
        if(flashT>0){ ctx.fillStyle = `rgba(255,255,255,${(flashT/0.1).toFixed(3)})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
        if(deathT<=0){ dying=false; if(!celebrating){ toStartScreen(); return; } }
        requestAnimationFrame(loop); return;
      }

      // Feiermodus (Highscore erreicht)
      if(celebrating){
        fireworksT -= dt; fireworkSpawnT -= dt;
        if(fireworkSpawnT<=0){ addFirework(80+Math.random()*(canvas.width-160), 80+Math.random()*(canvas.height*0.5)); fireworkSpawnT = 0.18 + Math.random()*0.28; }
        for(let i=fireworks.length-1;i>=0;i--){ const f=fireworks[i]; f.t+=dt; f.x+=f.vx*dt; f.y+=f.vy*dt; f.vy+=120*dt; if(f.t>f.life) fireworks.splice(i,1); }
        // Langsam Wolken/Berge bewegen
        clouds.forEach(c=> c.x -= 30*dt);
        mountains.forEach(m=> m.x -= 20*dt);

        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawSkyAndClouds();
        drawMountains();
        fireworks.forEach(f=>{ const a = 1 - f.t/f.life; if(a<=0) return; ctx.globalAlpha = Math.max(0, a); ctx.fillStyle = f.color; ctx.fillRect(f.x, f.y, f.size, f.size); ctx.globalAlpha = 1; });

        if(fireworksT<=0){ toStartScreen(); return; }
        requestAnimationFrame(loop); return;
      }

      // ===== Regulärer Spielablauf =====
      // Physik
      const gMult = player.fastFall ? 2.2 : 1;
      player.vy += currentG(speed)*gMult*dt; player.y += player.vy*dt; const gy=groundY(); if(player.y>gy-player.h){ player.y=gy-player.h; player.vy=0; player.onGround=true; player.fastFall=false; player.usedFastFall=false; }
      if(player.onGround){ player.runT+=dt; player.frameTime+=dt; if(player.frameTime>0.1){ player.frame=1-player.frame; player.frameTime=0; } }

      // Score & Difficulty
      score += dt*(12 + speed/38); difficulty=Math.min(1.5, difficulty+dt*0.05);

      // Trigger Cameos
      const iscore=Math.floor(score);
      while(iscore >= nextCameoScore){ spawnCameo(); nextCameoScore += 500; }
      while(iscore >= nextKienScore){ spawnKien(); nextKienScore += 1000; }
      while(iscore >= nextMingoatScore){ spawnMingoat(); nextMingoatScore += 5000; }

      // Spawns
      spawnT -= dt; if(spawnT<=0){ spawnObstacle(); const base = 2.6 - Math.min(1.5, difficulty*1.2); spawnT = (base + Math.random()*0.6) * (360/speed); }
      knobiSpawnT -= dt; if(knobiSpawnT<=0){ spawnKnobi(); knobiSpawnT=2+Math.random()*2; }

      // Bewegung
      obstacles.forEach(o=> o.x -= speed*dt);
      obstacles.forEach(o=>{ if(o.kind==='top'){ o.t += dt; o.y = o.baseY + Math.sin(o.t*o.freq)*o.amp; }});
      knobis.forEach(k=> { k.x -= speed*dt; });
      cameos.forEach(c=> c.x -= speed*c.par*dt);
      clouds.forEach(c=> c.x -= speed*c.par*dt);
      mountains.forEach(m=> m.x -= speed*m.par*dt);
      cloudT -= dt; if(cloudT<=0){ spawnCloud(false); cloudT = 2 + Math.random()*3; }
      mountainT -= dt; if(mountainT<=0){ spawnMountain(false); mountainT = 3 + Math.random()*5; }

      speed=Math.min(920, speed + 6*dt*60/60);

      // Mama Hanh
      const pRect={x:player.x-2, y:player.y + (player.duck?player.h*0.3:0), w:player.w, h:player.duck? player.h*0.7:player.h};
      for(const o of obstacles){ if(o.kind!=='ground' || o.counted) continue; const pLeft=pRect.x, pRight=pRect.x+pRect.w; const overlap=(pRight>o.x)&&(pLeft<o.x+o.w); if(overlap){ const pBottom=pRect.y+pRect.h; if(pBottom<=o.y+2){ o.jumped=true; } } if(pLeft>=o.x+o.w){ if(o.jumped){ mamaHanh++; score+=BONUS; addPopup(o.x+o.w/2, o.y-10, 'MAMA HANH MOMENT'); addSparks(o.x+o.w/2, o.y); } o.counted=true; } }

      // Update Popups & Sparks
      for(let i=popups.length-1;i>=0;i--){ const p=popups[i]; p.t += dt; p.y += p.vy*dt; if(p.t>p.dur) popups.splice(i,1); }
      for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.t+=dt; s.vy += s.g*dt; s.x += s.vx*dt; s.y += s.vy*dt; if(s.t>s.life) sparks.splice(i,1); }

      // Entsorgen Offscreen
      while(obstacles.length && obstacles[0].x + obstacles[0].w < -20) obstacles.shift();
      while(knobis.length && knobis[0].x < -30) knobis.shift();
      for(let i=cameos.length-1;i>=0;i--){ if(cameos[i].x + cameos[i].w < -60) cameos.splice(i,1); }
      for(let i=clouds.length-1;i>=0;i--){ if(clouds[i].x + clouds[i].w < -60) clouds.splice(i,1); }
      for(let i=mountains.length-1;i>=0;i--){ if(mountains[i].x + mountains[i].w < -80) mountains.splice(i,1); }

      // Kollisionen
      for(const o of obstacles){ if(rects(pRect,o)){ // Highscore-Check
          if(Math.floor(score) > best){ best = Math.floor(score); localStorage.setItem('bestScore', best); celebrating = true; fireworksT = 4.2; fireworkSpawnT = 0; celebrateBanner.classList.add('show'); }
          dying=true; deathT=0.22; shakeT=0.22; flashT=0.10; break; } }
      for(let i=knobis.length-1;i>=0;i--){ const k=knobis[i]; const r={x:k.x-k.size/2,y:k.y-k.size/2,w:k.size,h:k.size}; if(rects(pRect,r)){ if(sfxPop){ try{ sfxPop.currentTime=0; sfxPop.play(); }catch(e){} } knobiCount++; knobis.splice(i,1); } }

      // Zeichnen
      ctx.clearRect(0,0,canvas.width,canvas.height);
      draw();
      if(flashT>0){ ctx.fillStyle = `rgba(255,255,255,${(flashT/0.1).toFixed(3)})`; ctx.fillRect(0,0,canvas.width,canvas.height); }

      requestAnimationFrame(loop);
    }

    function syncPlayerToGround(){ player.y=groundY()-player.h; }
    startBtn.addEventListener('click', async ()=>{ startBtn.disabled=true; startBtn.textContent='⏳ Lädt…'; try{ await preload(); }catch(e){} startBtn.textContent='🎮 Start!'; syncPlayerToGround(); startGame(); setTimeout(()=> startBtn.disabled=false, 300); });
  </script>
</body>
</html>
